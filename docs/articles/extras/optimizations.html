<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Optimizations and Parallel Processing • tune</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="../../tidyverse.css" rel="stylesheet">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/all.min.css" integrity="sha256-nAmazAk6vS34Xqo0BSrTb+abbtFlgsFK7NKSi6o7Y78=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/v4-shims.min.css" integrity="sha256-6qHlizsOWFskGlwVOKuns+D1nB6ssZrHQrNj1wGplHc=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/headroom.min.js" integrity="sha256-DJFC1kqIhelURkuza0AvYal5RxMtpzLjFhsnVIeuk+U=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../../pkgdown.css" rel="stylesheet">
<script src="../../pkgdown.js"></script><link href="../../tidyverse-2.css" rel="stylesheet">
<meta property="og:title" content="Optimizations and Parallel Processing">
<meta property="og:description" content="">
<meta property="og:image" content="/logo.png">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>

      <div class="navbar-brand-container">
        <a class="navbar-brand" href="../../index.html">tune</a>
        <div class="info">
          <span class="partof">part of <a href="https://github.com/tidymodels">tidymodels</a></span>
          <span class="version version-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.0.1</span>
        </div>
      </div>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav navbar-right">
<li>
  <a href="../../articles/getting_started.html">Getting Started</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../../articles/grid.html">Grid Search</a>
    </li>
    <li>
      <a href="../../articles/acquisition_functions.html">Acquisition Functions</a>
    </li>
    <li>
      <a href="../../articles/extras/svm_classification.html">Bayesian Optimization of Classification Model</a>
    </li>
    <li>
      <a href="../../articles/extras/optimizations.html">Optimizations and Parallel Processing</a>
    </li>
    <li>
      <a href="../../articles/extras/text_analysis.html">Text Analysis Example</a>
    </li>
  </ul>
</li>
<li>
  <a href="../../reference/index.html">Reference</a>
</li>
<li>
  <a href="../../news/index.html">News</a>
</li>
        <li>
  <a href="https://github.com/tidymodels/tune">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="optimizations_files/jquery-1.11.3/jquery.min.js"></script><script src="optimizations_files/elevate-section-attrs-2.0/elevate-section-attrs.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Optimizations and Parallel Processing</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/tidymodels/tune/blob/master/vignettes/extras/optimizations.Rmd"><code>vignettes/extras/optimizations.Rmd</code></a></small>
      <div class="hidden name"><code>optimizations.Rmd</code></div>

    </div>

    
    
<p><code>tune</code> attempts to evaluate the candidate models in the shortest amount of time. This vignette is a summary of those approaches.</p>
<div id="sub-model-speed-ups" class="section level2">
<h2 class="hasAnchor">
<a href="#sub-model-speed-ups" class="anchor"></a>Sub-model speed-ups</h2>
<p>For some types of models, such as boosted models or regularized models, the number of models that are actually <em>fit</em> can be far less than the number of models evaluated. For example, suppose a boosted tree is fit with 1000 trees. Many boosting implementations let the user make predictions for any number of trees less than what was originally fit (1000 in this example). This “sub-model trick” can greatly speed up the training time for many models (e.g. see <a href="https://topepo.github.io/caret/using-your-own-model-in-train.html#illustrative-example-2-something-more-complicated---logitboost">this example</a> in the <code>caret</code> documentation).</p>
<p>In order to know what models allow this, the <code>parsnip</code> package contains a <code>multi_predict()</code> function that enables this feature. Printing the S3 methods for it lists the possible models:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1"></a><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(tidymodels)</span>
<span id="cb1-2"><a href="#cb1-2"></a><span class="kw"><a href="https://rdrr.io/r/utils/methods.html">methods</a></span>(<span class="st">"multi_predict"</span>)</span></code></pre></div>
<pre><code>## [1] multi_predict._C5.0*        multi_predict._earth*      
## [3] multi_predict._elnet*       multi_predict._lognet*     
## [5] multi_predict._multnet*     multi_predict._train.kknn* 
## [7] multi_predict._xgb.Booster* multi_predict.default*     
## see '?methods' for accessing help and source code</code></pre>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1"></a><span class="co"># There are arguments for the parameter(s) that can create multiple predictions.</span></span>
<span id="cb3-2"><a href="#cb3-2"></a><span class="co"># For xgboost, `trees` are cheep to evaluate: </span></span>
<span id="cb3-3"><a href="#cb3-3"></a>parsnip<span class="op">:::</span>multi_predict._xgb.Booster <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb3-4"><a href="#cb3-4"></a><span class="st">  </span><span class="kw"><a href="https://rdrr.io/r/base/formals.html">formals</a></span>() <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb3-5"><a href="#cb3-5"></a><span class="st">  </span><span class="kw"><a href="https://rdrr.io/r/base/names.html">names</a></span>()</span></code></pre></div>
<pre><code>## [1] "object"   "new_data" "type"     "trees"    "..."</code></pre>
<p>The same feature does not exist for recipes though.</p>
</div>
<div id="expensive-pre-processing" class="section level2">
<h2 class="hasAnchor">
<a href="#expensive-pre-processing" class="anchor"></a>Expensive pre-processing</h2>
<p>When tuning a recipe and a model, it makes sense to avoid <em>recreating</em> the recipe for each model.</p>
<p>For example, suppose that <a href="https://en.wikipedia.org/wiki/Isomap">Isomap multi-dimensional scaling</a> is used to pre-process the data prior to tuning a K-nearest neighbor regression:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1"></a><span class="kw"><a href="https://rdrr.io/r/utils/data.html">data</a></span>(Chicago)</span>
<span id="cb5-2"><a href="#cb5-2"></a>iso_rec &lt;-<span class="st"> </span></span>
<span id="cb5-3"><a href="#cb5-3"></a><span class="st">  </span><span class="kw">recipe</span>(ridership <span class="op">~</span><span class="st"> </span>., <span class="dt">data =</span> Chicago) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb5-4"><a href="#cb5-4"></a><span class="st">  </span><span class="kw">step_dummy</span>(<span class="kw">all_nominal</span>()) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb5-5"><a href="#cb5-5"></a><span class="st">  </span><span class="kw">step_isomap</span>(<span class="kw">all_predictors</span>(), <span class="dt">num_terms =</span> <span class="kw"><a href="../../reference/tune.html">tune</a></span>())</span>
<span id="cb5-6"><a href="#cb5-6"></a></span>
<span id="cb5-7"><a href="#cb5-7"></a>knn_mod &lt;-<span class="st"> </span></span>
<span id="cb5-8"><a href="#cb5-8"></a><span class="st">  </span><span class="kw">nearest_neighbor</span>(<span class="dt">neighbors =</span> <span class="kw"><a href="../../reference/tune.html">tune</a></span>(), <span class="dt">weight_func =</span> <span class="kw"><a href="../../reference/tune.html">tune</a></span>()) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb5-9"><a href="#cb5-9"></a><span class="st">  </span><span class="kw">set_engine</span>(<span class="st">"kknn"</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb5-10"><a href="#cb5-10"></a><span class="st">  </span><span class="kw">set_mode</span>(<span class="st">"regression"</span>)</span>
<span id="cb5-11"><a href="#cb5-11"></a></span>
<span id="cb5-12"><a href="#cb5-12"></a>grid &lt;-<span class="st"> </span></span>
<span id="cb5-13"><a href="#cb5-13"></a><span class="st">  </span><span class="kw"><a href="https://rdrr.io/pkg/dials/man/parameters.html">parameters</a></span>(<span class="kw">num_terms</span>(<span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dv">1</span>, <span class="dv">9</span>)), <span class="kw">neighbors</span>(), <span class="kw">weight_func</span>()) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb5-14"><a href="#cb5-14"></a><span class="st">  </span><span class="kw">grid_regular</span>(<span class="dt">levels =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dv">5</span>, <span class="dv">10</span>, <span class="dv">7</span>)) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb5-15"><a href="#cb5-15"></a><span class="st">  </span><span class="kw">arrange</span>(num_terms, neighbors, weight_func)</span>
<span id="cb5-16"><a href="#cb5-16"></a>grid </span></code></pre></div>
<pre><code>## # A tibble: 350 x 3
##    num_terms neighbors weight_func 
##  *     &lt;int&gt;     &lt;int&gt; &lt;chr&gt;       
##  1         1         1 biweight    
##  2         1         1 cos         
##  3         1         1 epanechnikov
##  4         1         1 inv         
##  5         1         1 rectangular 
##  6         1         1 triangular  
##  7         1         1 triweight   
##  8         1         2 biweight    
##  9         1         2 cos         
## 10         1         2 epanechnikov
## # … with 340 more rows</code></pre>
<p>To evaluate these 350 candidate models, we would have to recompute the same recipe 69 additional times (per resample). Since Isomap is expensive, this is really inefficient.</p>
<p><code><a href="../../reference/tune_grid.html">tune_grid()</a></code> determines when this occurs and fits all 70 candidate models for each unique configuration of the recipe. In essence, it nests the model parameters inside the unique parameters of the recipe:</p>
<pre><code>## # A tibble: 5 x 2
##   num_terms data             
## *     &lt;int&gt; &lt;list&gt;           
## 1         1 &lt;tibble [70 × 2]&gt;
## 2         3 &lt;tibble [70 × 2]&gt;
## 3         5 &lt;tibble [70 × 2]&gt;
## 4         7 &lt;tibble [70 × 2]&gt;
## 5         9 &lt;tibble [70 × 2]&gt;</code></pre>
<p>Only 5 recipes are prepared and, within each, all of the appropriate models are fit from the same recipe. In this example, once the recipe with <code>num_terms = 1</code> is created, the model parameters are iteratively tuned:</p>
<pre><code>## # A tibble: 70 x 2
##    neighbors weight_func 
##  *     &lt;int&gt; &lt;chr&gt;       
##  1         1 biweight    
##  2         1 cos         
##  3         1 epanechnikov
##  4         1 inv         
##  5         1 rectangular 
##  6         1 triangular  
##  7         1 triweight   
##  8         2 biweight    
##  9         2 cos         
## 10         2 epanechnikov
## # … with 60 more rows</code></pre>
<p>The same will be true for post-processing parameters being tuned. For each unique set of recipe and model parameters, the post-processing parameters will be evaluated without unnecessary re-fitting.</p>
<p>Also, when using a model formula, the model matrix is only created once per resample.</p>
</div>
<div id="parallel-processing" class="section level2">
<h2 class="hasAnchor">
<a href="#parallel-processing" class="anchor"></a>Parallel Processing</h2>
<p><code>tune</code> allows users, when possible, to use multiple cores or separate machines fit models. Currently, the package parallelizes the <em>resampling</em> loop of grid search<a href="#fn1" class="footnote-ref" id="fnref1"><sup>1</sup></a>.</p>
<p>The <code>foreach</code> package is used to facilitate parallel computations. <code>foreach</code> can use a variety of technologies to share the computations and the choice of technology is determined by which <em>parallel backend</em> package is chosen (aka the <code>do{technology}</code> packages). For example, the <code>doMC</code> package uses the forking mechanism on *unix systems to split the computations across multiple cores. As of this writing, the backend packages are <code>doFuture</code>, <code>doMC</code>, <code>doMPI</code>, <code>doParallel</code>, <code>doRedis</code>, <code>doRNG</code>, <code>doSNOW</code>, and <code>doAzureParallel</code> (GitHub only). Of these, <code>doFuture</code> and <code>doParallel</code> are probably the most comprehensive and best supported.</p>
<p>Registering a parallel backend is also somewhat dependent of the package. For <code>doParallel</code>, one could use:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1"></a>all_cores &lt;-<span class="st"> </span>parallel<span class="op">::</span><span class="kw"><a href="https://rdrr.io/r/parallel/detectCores.html">detectCores</a></span>(<span class="dt">logical =</span> <span class="ot">FALSE</span>)</span>
<span id="cb9-2"><a href="#cb9-2"></a></span>
<span id="cb9-3"><a href="#cb9-3"></a><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(doParallel)</span>
<span id="cb9-4"><a href="#cb9-4"></a>cl &lt;-<span class="st"> </span><span class="kw">makePSOCKcluster</span>(all_cores)</span>
<span id="cb9-5"><a href="#cb9-5"></a><span class="kw"><a href="https://rdrr.io/pkg/doParallel/man/registerDoParallel.html">registerDoParallel</a></span>(cl)</span></code></pre></div>
<p>Other options exist in <code>doParallel</code>.</p>
<p><code>doFuture</code> uses a function called <code>plan</code> to <a href="https://cran.r-project.org/web/packages/doFuture/vignettes/doFuture.html">declare the method</a>:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1"></a>all_cores &lt;-<span class="st"> </span>parallel<span class="op">::</span><span class="kw"><a href="https://rdrr.io/r/parallel/detectCores.html">detectCores</a></span>(<span class="dt">logical =</span> <span class="ot">FALSE</span>)</span>
<span id="cb10-2"><a href="#cb10-2"></a></span>
<span id="cb10-3"><a href="#cb10-3"></a><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(doFuture)</span>
<span id="cb10-4"><a href="#cb10-4"></a><span class="kw"><a href="https://rdrr.io/pkg/doFuture/man/registerDoFuture.html">registerDoFuture</a></span>()</span>
<span id="cb10-5"><a href="#cb10-5"></a>cl &lt;-<span class="st"> </span><span class="kw">makeCluster</span>(all_cores)</span>
<span id="cb10-6"><a href="#cb10-6"></a><span class="kw">plan</span>(cluster, <span class="dt">workers =</span> cl)</span></code></pre></div>
<p>One downside to parallel processing is that the different technologies handle inputs and outputs differently. For example, multicore forking <em>tends</em> to carry the loaded packages and objects into the worker processes. Others do not. To make sure that the correct packages are loaded (but not attached) in the workers is to use the <code>pkg</code> option in <code><a href="../../reference/control_grid.html">control_grid()</a></code>.</p>
<p>Some helpful advice to avoid errors in parallel processing is to not use variables in the global environment. These may not be found when the code is run inside of a worker process. For example:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1"></a>num_pcs &lt;-<span class="st"> </span><span class="dv">3</span></span>
<span id="cb11-2"><a href="#cb11-2"></a></span>
<span id="cb11-3"><a href="#cb11-3"></a><span class="kw">recipe</span>(Species <span class="op">~</span><span class="st"> </span>., <span class="dt">data =</span> iris) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb11-4"><a href="#cb11-4"></a><span class="st">  </span><span class="co"># Bad since num_pcs might not be found by a worker process</span></span>
<span id="cb11-5"><a href="#cb11-5"></a><span class="st">  </span><span class="kw">step_pca</span>(<span class="kw">all_predictors</span>(), <span class="dt">num_comp =</span> num_pcs)</span>
<span id="cb11-6"><a href="#cb11-6"></a></span>
<span id="cb11-7"><a href="#cb11-7"></a><span class="kw">recipe</span>(Species <span class="op">~</span><span class="st"> </span>., <span class="dt">data =</span> iris) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb11-8"><a href="#cb11-8"></a><span class="st">  </span><span class="co"># Good since the value is injected into the object</span></span>
<span id="cb11-9"><a href="#cb11-9"></a><span class="st">  </span><span class="kw">step_pca</span>(<span class="kw">all_predictors</span>(), <span class="dt">num_comp =</span> <span class="op">!!</span>num_pcs)</span></code></pre></div>
<p>This issue is likely to occur if <code><a href="https://dplyr.tidyverse.org/reference/reexports.html">dplyr::one_of()</a></code> is used as a sector.</p>
<p>Also note that almost all of the logging provided by <code><a href="../../reference/tune_grid.html">tune_grid()</a></code> will not be seen when running in parallel. Again, this is dependent on the backend package and technology being used.</p>
</div>
<div class="footnotes">
<hr>
<ol>
<li id="fn1"><p>There will be more options in the future to control this since the current implementation doesn’t help for cases when many models are fit over a single resample of the data (such as a validation set).<a href="#fnref1" class="footnote-back">↩︎</a></p></li>
</ol>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#sub-model-speed-ups">Sub-model speed-ups</a></li>
      <li><a href="#expensive-pre-processing">Expensive pre-processing</a></li>
      <li><a href="#parallel-processing">Parallel Processing</a></li>
      </ul>
</div>
      </div>

</div>



      <footer><div class="tidyverse">
  <p>tune is a part of the <strong>tidymodels</strong> ecosystem, a collection of modeling packages designed with common APIs and a shared philosophy.</p>
</div>

<div class="author">
  <p>
    Developed by Max Kuhn.
    Site built by <a href="https://pkgdown.r-lib.org">pkgdown</a>.
  </p>
</div>

      </footer>
</div>

  


  </body>
</html>
